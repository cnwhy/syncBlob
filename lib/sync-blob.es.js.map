{"version":3,"file":"sync-blob.es.js","sources":["../src/index.ts"],"sourcesContent":["const fixLatin1: <T = string | number>(v: T) => T = (() => {\n  const offset = 128;\n  const u8 = new Uint8Array(256 - offset);\n  u8.forEach((v, i) => (u8[i] = i + offset));\n  const decode = new TextDecoder(\"ISO-8859-1\");\n  const str = decode.decode(u8);\n  const map = new Map();\n  u8.forEach((v, i) => {\n    const code = str.charCodeAt(i);\n    const s = str.charAt(i);\n    if (v !== code) {\n      map.set(code, v); // code 映射\n      map.set(s, String.fromCharCode(v)); // 字符映射\n    }\n  });\n  if (!map.size) return (v) => v;\n  return (v) => (map.has(v) ? map.get(v) : v);\n})();\n\nconst syncReadBlob = (blob: Blob, charset = \"ISO-8859-1\") => {\n  const url = globalThis.URL.createObjectURL(blob);\n  const req = new XMLHttpRequest();\n  req.open(\"GET\", url, false);\n  req.overrideMimeType(`text/plain;charset=${charset}`);\n  req.send(null);\n  globalThis.URL.revokeObjectURL(url)\n  return req.response as string;\n};\n\n/**\n * Blob对像转为字符串\n * @param blob \n * @param charset 字符编码，默认取blob.type中的字符编码信息或utf-8\n * @returns \n */\nexport const blob2String = (blob: Blob, charset?:string) => {\n  if(!charset){\n    const match = blob.type?.match(/;[\\W]*charset=(.+)$/)\n    charset = match?.[1] ?? 'ISO-8859-1';\n  }\n  const str = syncReadBlob(blob, charset);\n  const lint1Names = [\"ISO-8859-1\", \"LATIN-1\", \"LATIN1\"];\n  if (lint1Names.includes(charset.toLocaleUpperCase())) {\n    return Array.from(str, (s) => fixLatin1(s)).join(\"\");\n  }\n  return str;\n};\n\nexport const blob2buffer = (blob: Blob) => {\n  const str = syncReadBlob(blob);\n  const u8 = Uint8Array.from(str, (v) => fixLatin1(v.charCodeAt(0)));\n  return u8.buffer;\n};\n\nexport const blob2Base64 = (blob: Blob) => {\n  const str = syncReadBlob(blob);\n  const max = str.length;\n  const block = 1024 * 500; // 每次转换的大小\n  let offset = 0;\n  let base64 = [] as string[];\n  do {\n    base64.push(\n      btoa(Array.from(str.substring(offset, offset + block), (v) => fixLatin1(v)).join(\"\"))\n    );\n    offset += block;\n  } while (offset < max);\n  return base64.join(\"\");\n};\n\n// TODO 后续添加\n// export const blob2dataUrl = (blob: Blob) => {\n// };\n\nexport default {\n  blob2String,\n  blob2buffer,\n  blob2Base64,\n};\n"],"names":[],"mappings":"AAAA,MAAM,aAA+C,MAAM;AACzD,QAAM,SAAS;AACf,QAAM,KAAK,IAAI,WAAW,MAAM,MAAM;AACtC,KAAG,QAAQ,CAAC,GAAG,MAAO,GAAG,CAAC,IAAI,IAAI,MAAO;AACzC,QAAM,SAAS,IAAI,YAAY,YAAY;AAC3C,QAAM,MAAM,OAAO,OAAO,EAAE;AAC5B,QAAM,0BAAU,IAAA;AAChB,KAAG,QAAQ,CAAC,GAAG,MAAM;AACnB,UAAM,OAAO,IAAI,WAAW,CAAC;AAC7B,UAAM,IAAI,IAAI,OAAO,CAAC;AACtB,QAAI,MAAM,MAAM;AACd,UAAI,IAAI,MAAM,CAAC;AACf,UAAI,IAAI,GAAG,OAAO,aAAa,CAAC,CAAC;AAAA,IAAA;AAAA,EACnC,CACD;AACD,MAAI,CAAC,IAAI,KAAM,QAAO,CAAC,MAAM;AAC7B,SAAO,CAAC,MAAO,IAAI,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,IAAI;AAC3C,GAAA;AAEA,MAAM,eAAe,CAAC,MAAY,UAAU,iBAAiB;AAC3D,QAAM,MAAM,WAAW,IAAI,gBAAgB,IAAI;AAC/C,QAAM,MAAM,IAAI,eAAA;AAChB,MAAI,KAAK,OAAO,KAAK,KAAK;AAC1B,MAAI,iBAAiB,sBAAsB,OAAO,EAAE;AACpD,MAAI,KAAK,IAAI;AACb,aAAW,IAAI,gBAAgB,GAAG;AAClC,SAAO,IAAI;AACb;AAQO,MAAM,cAAc,CAAC,MAAY,YAAoB;AAnC5D;AAoCE,MAAG,CAAC,SAAQ;AACV,UAAM,SAAQ,UAAK,SAAL,mBAAW,MAAM;AAC/B,eAAU,oCAAQ,OAAR,YAAc;AAAA,EAAA;AAE1B,QAAM,MAAM,aAAa,MAAM,OAAO;AACtC,QAAM,aAAa,CAAC,cAAc,WAAW,QAAQ;AACrD,MAAI,WAAW,SAAS,QAAQ,kBAAA,CAAmB,GAAG;AACpD,WAAO,MAAM,KAAK,KAAK,CAAC,MAAM,UAAU,CAAC,CAAC,EAAE,KAAK,EAAE;AAAA,EAAA;AAErD,SAAO;AACT;AAEO,MAAM,cAAc,CAAC,SAAe;AACzC,QAAM,MAAM,aAAa,IAAI;AAC7B,QAAM,KAAK,WAAW,KAAK,KAAK,CAAC,MAAM,UAAU,EAAE,WAAW,CAAC,CAAC,CAAC;AACjE,SAAO,GAAG;AACZ;AAEO,MAAM,cAAc,CAAC,SAAe;AACzC,QAAM,MAAM,aAAa,IAAI;AAC7B,QAAM,MAAM,IAAI;AAChB,QAAM,QAAQ,OAAO;AACrB,MAAI,SAAS;AACb,MAAI,SAAS,CAAA;AACb,KAAG;AACD,WAAO;AAAA,MACL,KAAK,MAAM,KAAK,IAAI,UAAU,QAAQ,SAAS,KAAK,GAAG,CAAC,MAAM,UAAU,CAAC,CAAC,EAAE,KAAK,EAAE,CAAC;AAAA,IAAA;AAEtF,cAAU;AAAA,EAAA,SACH,SAAS;AAClB,SAAO,OAAO,KAAK,EAAE;AACvB;AAMA,MAAA,QAAe;AAAA,EACb;AAAA,EACA;AAAA,EACA;AACF;"}